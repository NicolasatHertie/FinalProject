---
title: "Collaborative Research Project - Assignment 3"
bibliography: RpackageCitations.bib
date: "14 November 2014"
output: 
  pdf_document:
    number_sections: yes
highlight: zenburn
authors: Meilin Moellenkamp and Nicolas Rosemberg
---

```{r, echo=FALSE, include=FALSE, error=FALSE}
### 1. Setting Working Directory & Loading the data
# Setting the Working Directory
setwd("/Users/Meilin/Desktop/Collaborative Social Data/FinalProject")
# setwd("/Users/Nico/Documents/Hertie/Social science data analysis/Final project/FinalProject")

# Loading the Citations
pkgs <- c("RJSONIO","WDI","dplyr","tidyr","knitr","DataCombine","lmtest","httr","XML","plyr","Amelia","XLConnect","countrycode","ggplot2","magrittr","fmsb","car","stargazer")
repmis::LoadandCite(pkgs, file = 'RpackageCitations.bib')

# Loading the merged files from the Working directory
Merged <- read.csv(file="MergedData")
```


```{r, echo=FALSE, include=FALSE, error=FALSE}

### 2. Load Required Packages

# install.packages("RJOSONIO")  
library(RJSONIO)
# install.packages("WDI")  
library(WDI)
# install.packages("dplyr")  
library(dplyr) 
# install.packages("tidyr")  
library(tidyr)
# install.packages("httr")  
library(httr) 
# install.packages("dplyr")  
library(dplyr)
# install.packages("XML")  
library(XML)
#install.packages("plyr")
library(plyr)
# install.packages("Amelia")  
library(Amelia) 
#install.packages("XLConnect")
library(XLConnect)    
# install.packages("countrycode")
library("countrycode")
# install.packages ("ggplot2")
library(ggplot2)
# # install.packages ("magrittr")
library(magrittr)
# install.packages ("fmsb")
library(fmsb)
# install.packages ("car")
library(car)
# install.packages("stargazer")
library(stargazer)
```

```{r, echo=FALSE, include=FALSE, error=FALSE}
# 8. Creating further required variables 

# Lagging the dependent variable
Merged <- slide(Merged, Var = "Incidence", GroupVar = "iso2c", slideBy = -1,
                NewVar = "Incidence2")


# Creating a file with the difference between t0 and t1
Merged$IncidenceDif <- as.numeric(Merged$Incidence) - as.numeric(Merged$Incidence2)

# Creating a dummy variable for countries with IndicenceDif>0
Merged$DDif <- as.numeric(Merged$IncidenceDif<=0)
```

# Data Gathering and Cleaning

This section focuses on the process of gathering the data and cleaning the databases to prepare the variables for the data analysis. 

The first step in this process was uploading the databases to R Studio. The first dataset consists of 29 World Development Indicators and it was downloaded from World Bank's website. These indicators represent the independent variables used for this research plus the population indicator that is used to filter small countries. Provided that the focus of this research is on country level data, all regional data was dropped. Further, 169 rows that contained only NA values were deleted.

After dropping empty rows, the data frame was alphabetically (ascending) ordered, rows were grouped by iso2c code and variables were renamed.

The dataset was further cleaned preparing the data for imputation using the AMELIA package. The imputation will be conducted however at a further stage of the research. This process requires that the panel is as balanced as possible, as it feeds from all variables to predict values for the missing observations. The next step was thus dropping variables for which more than 80% of the observations (552) were missing.  In addition, countries with a population smaller than one million inhabitants were dropped from the database. 59 countries fell in that category: 46 islands, 5 European countries (Andorra, Liechtenstein, Luxemburg, Monaco and Montenegro), Bahrain, Bhutan, Belize, Djibouti, Equatorial Guinea, Guyana, Qatar and Suriname. Dropping these countries does not affect the research as the remaining database still contains a highly heterogeneous sample both in geographic and socio-economic terms. Furthermore, deleting these countries improves the dataset as most of these countries lacked information for most of the studied variables. 
 
The second database used for this research was downloaded from UNAIDS' website and it provides information on HIV/AIDS incidence rates (as well as prevalence and deaths caused by HIV/AIDS). The data is publicly available. All columns except the country and the incidence rate were dropped. 
After renaming the variables, a unique identifier was created and missing values were recoded as NAs. Moreover, some observations in the database were not specific numbers; instead, it was indicated that for that year, prevalence was below a certain threshold (0.01%). In those cases, these observations were replaced by 0.009. The final step in the cleaning of the UNAIDS database consisted of deleting missing values for the dependent variable and deleting the regions with an iso2c equal to a country's iso2c (NA and ZA) to avoid problems in the merging process. 

Once both databases were cleaned, the next step was to merge the datasets using the combination of iso2c and year as unique identifier. In the merging process, only observations that were present in both datasets were kept. It is worth noticing that UNAIDS' dataset included observations from 1990 to 2012 so all observation between 1990 and 1999 were dropped. Finally, unnecessary columns from the new database were eliminated.

# Descriptive Statistics

The descriptive statistics part consists of the preparation of the variables for data analysis. Tables, plots and histograms are shown to understand the distribution of the variables. 
Table 1 shows the main descriptive statistics of all the variables that can be found in the cleaned dataset (number of observations, mean, standard deviation, and min and max values).

```{r, echo=FALSE, results="asis", error=FALSE, include=FALSE}
stargazer(Merged, type = "latex", title="Descriptive statistics", digits=1, out="table1.txt")
```

\pagebreak

The histogram of the dependent variable (Figure 1) shows that the incidence rates are not normally distributed but strongly skewed to the left and only few incidence rates are higher than 1. 


```{r, echo=FALSE}

### 1. Plotting the dependent variable

# Histogram of dependent variable
Histdep <- hist(Merged$Incidence, breaks= seq(0,5,by=0.1), xlab="HIV Incidence Rate", main="Figure 1: Incidence Rate")
axis(side=1, at=seq(0,5, 0.5), labels=seq(0,5,0.5))
axis(side=2, at=seq(0,800,100), labels=seq(0,800,100))

```

Figure 2 shows that in most countries of our dataset HIV/AIDS incidence rates decreased between the period of 2000 to 2015 (see Figure 2).
```{r, echo=FALSE, include=FALSE}
# Look at incidence over time - seee the general trend
IncT <- ggplot(aes(x = year, y = Incidence), data = Merged) + geom_point(position = "jitter") + theme_bw() + geom_smooth()
IncT <- IncT + ggtitle("Figure 2: Incidence Rate over Time") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig2.png", width=4, height=5, dpi=100)
```

<img src="fig2.png" align="center"


When plotting the incidence rates per country (Figure 3 in repository) the range of observations per country is shown and the outliers (countries with high incidence rates) can be identified.
``` {r, echo=FALSE, include=FALSE}
# Look at incidence rate per country
IncC <- ggplot2::ggplot(Merged, aes(Incidence, country)) + geom_point() + theme_bw()
IncC + ggtitle("Figure 3: Incidence Rate per Country") + theme(plot.title = element_text(lineheight=3, face="bold"))

ggsave("fig3.png", width=8, height=10, dpi=100)

```

![](fig3.png)

As the research question investigates why MDG 6.A is not being reached by some countries, the general HIV incidence rate is interesting, but also the decrease in the incidence rate from 2000 to 2015 is even more relevant. As stated in the research proposal Target 6.A of the MDGs specifies that countries should "have halted by 2015 and begun to reverse the spread of HIV/AIDS" [United Nations (2014)]. 

\pagebreak

For this purpose, the dependent variable was lagged by one period and the difference between the lag and the current year was calculated (see Figure 4 in repository).

```{r, echo=FALSE, include=FALSE}
# Look at difference in incidence rate per country between one year to the next
IncClag <- ggplot2::ggplot(Merged, aes(IncidenceDif, country)) + geom_point() + theme_bw()
IncClag + ggtitle("Figure 4: Change in Incidence Rate compared to Previous Years") + theme(plot.title = element_text(lineheight=3, face="bold"))

ggsave("fig4.png", width=8, height=10, dpi=100)
```

![](fig4.png)

\pagebreak

Further, a dummy variable was created assigning a value of zero for those observations where the incidence rate decreased compared to the previous year or stayed the same (countries reaching MDG 6.A) and a value of one was assigned to those observations where the incidence rate increased (countries not reaching MDG 6.A). Figure 4 shows the direction of the change in the incidence rate compared to the previous year by country.

```{r, echo=FALSE}

### 1. Plotting the new dependent variable

# Histogram of new dependent variable
Histdep <- hist(Merged$DDif, breaks= seq(0,1.5,by=0.1), xlab="Dummy Coding: Change in Incidence Rate", main="Figure 5: Dummy Variable")
axis(side=2, at=seq(0,800,100), labels=seq(0,800,100))
```

Scatterplots were used for each category of Dahlgrehn's model in order to see whether the variables are skewed or multicollinear (Figures 5, 6 & 7).


```{r, echo=FALSE}

options(digits = 4)

# Creating subsets
HighIncidence <- Merged[which (Merged$country=="Zimbabwe" | Merged$country=="Zambia"| Merged$country=="Swaziland" | Merged$country=="South Africa" | Merged$country=="Namibia" | Merged$country=="Mozambique" | Merged$country=="Lesotho" | Merged$country=="Malawi" | Merged$country=="Botswana"  | Merged$country=="Uganda"  | Merged$country=="Sierra Leone"  | Merged$country=="Papua New Guinea"), ] 

Cases <- ggplot(data=HighIncidence, aes(x=year, y=Incidence, group=country, color=country)) + geom_line() + geom_point()
                                                                                                                          
Cases <- Cases + ggtitle("Figure 6: Interesting Cases for HIV Incidence Rates") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig5.png", width=7, height=8, dpi=100)
```

# Case Studies - Botswana, Lesotho, Uganda & Malawi

```{r, echo=FALSE, results='asis', include=FALSE}

# Creating subsets
CaseStudies <- Merged[which (Merged$country=="Botswana" | Merged$country=="Lesotho" | Merged$country=="Malawi" | Merged$country=="Uganda"), ] 

Water <- ggplot(data=CaseStudies, aes(x=year, y=Water, group=country, color=country)) + geom_line() + geom_point()
Water <- Water + ggtitle("Figure 7: Access to Water in Selected Countries") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig7.png", width=7, height=8, dpi=100)

Sanitation <- ggplot(data=CaseStudies, aes(x=year, y=Sanitation, group=country, color=country)) + geom_line() + geom_point()
Sanitation <- Sanitation + ggtitle("Figure 8: Access to Sanitation in Selected Countries") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig8.png", width=7, height=8, dpi=100)

GDP <- ggplot(data=CaseStudies, aes(x=year, y=GDPpc, group=country, color=country)) + geom_line() + geom_point()
GDP <- GDP + ggtitle("Figure 9: GDPpc in Selected Countries") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig9.png", width=7, height=8, dpi=100)

FemSchool <- ggplot(data=CaseStudies, aes(x=year, y=FemSchool, group=country, color=country, shape=country))  + geom_line () + geom_point()
FemSchool <- FemSchool + ggtitle("Figure 10: Level of Female Schooling in Selected Countries") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig10.png", width=7, height=8, dpi=100)

FemUnempl <- ggplot(data=CaseStudies, aes(x=year, y=FemUnempl, group=country, color=country, shape=country)) + geom_line() + geom_point() + stat_smooth()
FemUnempl <- FemUnempl + ggtitle("Figure 11: Level of Female Unemployment in Selected Countries") + theme(plot.title = element_text(lineheight=3, face="bold"))
ggsave("fig11.png", width=7, height=8, dpi=100)

ggplot(data=CaseStudies, aes(x=year, y=Rural, group=country, color=country, shape=country)) + geom_line() + geom_point()

ggplot(data=CaseStudies, aes(x=year, y=HCexpend, group=country, color=country, shape=country)) + geom_line() + geom_point()

ggplot(data=CaseStudies, aes(x=year, y=HCexpendpc, group=country, color=country, shape=country)) + geom_line() + geom_point()

```

# Inferential Statistics

```{r, echo=FALSE}
###  Imputing missing values with amelia package

### Check if all Variables are coded as numeric
str(Merged)
# Code variables as numeric
Merged$Incidence <- as.numeric(Merged$Incidence)
Merged$DPT <- as.numeric(Merged$DPT)
Merged$Measles <- as.numeric(Merged$Measles)

# check for Variance Inflation
collinear1 <- lm(Incidence ~ GDP + GDPpc + Rural + CO2 + HCexpend + Primary + Water + Sanitation + Unemploym + HCexpendpc + FemUnempl + FemSchool + LifeExpect + DPT + Measles + Population, data=Merged)
```

```{r, echo=FALSE, type = 'latex', header = FALSE}
# Testing for multicollinearity 1st time
 collinear1 <- vif(collinear1)

knitr::kable(collinear1, align = 'c', digits = 2,
      caption = 'Variance Inflation Factors 1')

```

```{r, echo=FALSE}
collinear2 <- lm(Incidence ~ GDPpc + Rural + CO2 + HCexpend + Water + Sanitation + Unemploym + HCexpendpc + FemUnempl + FemSchool + LifeExpect + DPT + Measles + Population, data=Merged)
vif(collinear2)
```


```{r, echo=FALSE, type = 'latex', header = FALSE}
# Testing for multicollinearity
collinear2 <- vif(collinear2)

knitr::kable(collinear2, align = 'c', digits = 2,
      caption = 'Variance Inflation Factors 2')

```

As can be seen from the Scatterplots (see appendix) most of the variables are not normally distributed. Further, the variables all have different scales. Therefore, the independent variables were logged for enabling comparisons in the data analysis part.

```{r, echo=FALSE, include=FALSE}

### Preparing the datset for Imputations
# drop collinear variables
Merged$GDP <- NULL
Merged$Primary <- NULL
Merged$IncidenceDif <- NULL

# Logging the independent variables for better comparability and imputations
Merged$lGDPpc <- log(Merged$GDPpc)
Merged$lRural <- log(Merged$Rural)
Merged$lCO2 <- log(Merged$CO2)
Merged$lHCexpend <- log(Merged$HCexpend)
Merged$lWater <- log(Merged$Water)
Merged$lSanitation <- log(Merged$Sanitation)
Merged$lUnemploym <- log(Merged$Unemploym)
Merged$lHCexpendpc <- log(Merged$HCexpendpc)
Merged$lFemUnempl <- log(Merged$FemUnempl)
Merged$lFemSchool <- log(Merged$FemSchool)
Merged$lLifeExpect <- log(Merged$LifeExpect)
Merged$lDPT <- log(Merged$DPT)
Merged$lMeasles <- log(Merged$Measles)


# Creating a new variable with FemSchool by quintiles
Merged$QFemSchool <- Merged$lFemSchool
Merged$QFemSchool[Merged$lFemSchool<=4.53] <-1
Merged$QFemSchool[Merged$lFemSchool>4.53 & Merged$lFemSchool<=4.622] <-2
Merged$QFemSchool[Merged$lFemSchool>4.622 & Merged$lFemSchool<=4.697] <-3
Merged$QFemSchool[Merged$lFemSchool>4.697] <-4


# Creating dependent variable as Dummy (0 if above the mean, 1 if below the mean)
mean(Merged$Incidence)

Merged$Dummy[Merged$Incidence %in% 0.3493199:1] <- 0
Merged$Dummy[Merged$Incidence %in% 0:0.3493198] <- 1
summary(Merged$Dummy)

Merged$Dummy <- as.numeric(Merged$Incidence<=0.3493198)

hist(Merged$Dummy)


# Creating a variable with the inverse from FemUnempl
Merged$Inverse <- 1/Merged$FemUnempl
Merged$Inverse <- log(Merged$Inverse)
Merged$FemUnempl <- NULL
Merged$lFemUnempl <- NULL
```

```{r, echo=FALSE, include=FALSE}
### Imputing the missing values
Imputed.out <- amelia(Merged, m = 5, ts = "year", cs = "iso2c", idvars = "country", ords= c("QFemSchool", "Dummy", "DDif"))
save(Imputed.out, file = "imputations.RData")
#write.amelia(obj=Imputed.out, file.stem = "outdata", separate=FALSE)

# Imputed1.out <- transform(Imputed.out, Incidence>1)

for (i in 1:5){
  Imputed.out$imputations[[i]]$QFemSchool <- factor(Imputed.out$imputations[[i]]$QFemSchool,levels=1:4)
}

class(Imputed.out$imputations[[1]]$QFemSchool)


hist(Imputed1.out$Imputed)

summary(Imputed.out)
png(file="plotamelia.png", width=15, height=15)
plot(Imputed.out)

dev.off()
save(plotamelia, file = "plotamelia.png")

#Imputed <- read.csv(file="outdata1.csv")
```

```{r, echo=FALSE, include=FALSE}
# 9. Dropping the year 2000???

#Imputed$DDif[Imputed$year==2000] 
```

As the dependent variable is coded as a dummy, being 1 if MDG 6.A is reached and 0 for countries that are not reaching MDG 6.A logistic regressions are used for the inferential statistics part. As Odds and Odds ratios are difficult to present to a broad audience predicted probabilities are calculated after running the logistic regressions. The interpretation of the results will mainly focus on the predicted probabilities.


```{r, echo=FALSE, results="asis", error=FALSE}
#### MODEL - Running a general logistic regression using all independent variables

#install.packages("Zelig")
library(Zelig)
L1.out <- zelig(Dummy ~ lGDPpc + lRural + lCO2 + lHCexpend + lWater + lSanitation + lLifeExpect + lDPT + lMeasles + Inverse + lFemSchool, data = Imputed.out, model = "logit")

summary(L1.out)


a.out <- zelig(Dummy ~ lGDPpc + lRural + lCO2 + lHCexpend + lWater + lSanitation + lLifeExpect + lDPT + lMeasles + Inverse + QFemSchool, data = Imputed.out, model = "logit")

summary(a.out)



# Regressing the model on FemSchool fixing the other indendent variables at Uganda's mean
x1.out <-  setx(a.out, lGDPpc = 7.003, 
              lRural = 4.461,
              lCO2 = -2.52,
              lHCexpend = 2.125,
              lLifeExpect = 3.98,
              lWater = 4.18,
              lSanitation = 3.46,
              lDPT = 4.199,
              lMeasles = 4.235,
              Inverse = -1.2576,
             QFemSchool = 1:4)

x2.out <-  setx(a.out, lGDPpc = 7.003, 
              lRural = 4.461,
              lCO2 = -2.52,
              lHCexpend = 2.125,
              lLifeExpect = 3.98,
              lWater = 4.18,
              lSanitation = 3.46,
              lDPT = 4.199,
              lMeasles = 4.235,
              Inverse = -1.2576,
              QFemSchool = 2)

x3.out <-  setx(a.out, lGDPpc = 7.003, 
              lRural = 4.461,
              lCO2 = -2.52,
              lHCexpend = 2.125,
              lLifeExpect = 3.98,
              lWater = 4.18,
              lSanitation = 3.46,
              lDPT = 4.199,
              lMeasles = 4.235,
              Inverse = -1.2576,
              QFemSchool = 3)

x4.out <-  setx(a.out, lGDPpc = 7.003, 
              lRural = 4.461,
              lCO2 = -2.52,
              lHCexpend = 2.125,
              lLifeExpect = 3.98,
              lWater = 4.18,
              lSanitation = 3.46,
              lDPT = 4.199,
              lMeasles = 4.235,
              Inverse = -1.2576,
              QFemSchool = 4)




s.out <- sim(a.out, x = x1.out)

plot(s.out)

?sim

# Calculating the predicted probabilities
z.out <- sim(L1.out, x = x.out)


   > data(turnout)
     > z.out <- zelig(vote ~ race + age, model = "logit", data = turnout)
     > x.out <- setx(z.out, race = "white")
     > s.out <- sim(z.out, x = x.out)
     > summary(s.out)


Predicted_1

x.out1 <- setx(L1.out, country = 36, race = "white")

setx(L1.out)
sim(L1.out, x = L1.out, x1 = NULL)
L1.results <- lapply(L1.out, function(x) x$result)

summary(L1)



### labels <- c('(Intercept)', 'GDP per capita', 'Rural', 'CO2',
            #'Healthcareexpenditure', 'lWater', 'Sanitation', 'Inverse', 'FemSchool2',
            #'FemSchool3', 'FemSchool4', 'Inverse2', 'Inverse3', 'Inverse4', 'FemSchool',
            #'Life expectancy', 'DPT', 'Measles', 'Interaction2', 'Interaction3', 'Interaction4', 
            #'Constant')

```

The test for variance inflation factors showed that in our first logistic regression model six variables showed high multicollinearity and had a higher variance inflation than the threshold of 10. We tested the multicollinearity between the variables and found that there was high multicollinearity between the GDP and GDP per capital, Unemployment and Female unemployment, Primary education and female schooling. Therefore, we excluded one of these multicollinear variables for each group based on their explanatory strength for our research question, namely unemployment, primary education and GDP.

# Limitations

The paper had to make some compromises regarding its original aim as outlined in the first research proposal. Due to the significant amount of missing values and the presence of multicollinearity, a considerable number of variables had to be dropped and could ultimately not be integrated in the logistic regression models. 
 
The selection of these variables was not arbitrary but followed instead the theoretical framework guiding this research, i.e. Dahlgren's model. Two levels of Dahlgren's model (Social and Community Networks and Individual Lifestyle Factors) ended up underrepresented after dropping these variables. To deal with this limitation, the research will only use the theoretical framework as an instrument to guide the selection of variables but will not utilise the findings to test the validity of the model. 
 
In terms of the data used to run the regressions, the relative high number of countries that have already halted or reversed the spread of HIV/AIDS in our sample can lead to biased results. In the next stage of the research, the effect of excluding those countries that only halted the spread will be explored. 
 
Another shortcoming faced at this stage was the integration of figures from the descriptive statistics into the final report. A transitory solution was to save those pictures in a subfolder of the repository.

# Appendix

**Scatterplot of variables for socio-economic, cultural and environmental conditions**

```{r, echo=FALSE}
# Scatterplot of variables for socio-economic, cultural and environmental conditions
#scatterplotMatrix(~ Incidence + GDPpc + Rural + CO2 + LifeExpect + Population, 
                  #transform=TRUE, data=Merged)
```


\pagebreak
**Scatterplot of variables for living and working conditions**

```{r, echo=FALSE}
# Scatterplot of variables for living and working conditions 
#scatterplotMatrix(~ Incidence + Water + Sanitation + Unemploym + HCexpendpc,
                  #transform=TRUE, data=Merged)
```


**Scatterplot of variables for individual lifestyle factors**

```{r, echo=FALSE}
# Scatterplot of variables for individual lifestyle factors
#scatterplotMatrix(~ Incidence + DPT + Measles, transform=TRUE, data=Merged)

```
